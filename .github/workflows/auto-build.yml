---
name: è‡ªåŠ¨ç¼–è¯‘å’Œå‘å¸ƒ

'on':
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.os == 'windows-2022' && 60 || 30 }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, ubuntu-latest]
        include:
          - os: windows-2022
            timeout: 60
          - os: ubuntu-latest
            timeout: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ç¼“å­˜Nuitkaæ„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.cache/Nuitka
          key: ${{ runner.os }}-nuitka-${{
            hashFiles('**/build_with_nuitka.py', '**/main.py') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka==2.4.11
          pip install ordered-set
          pip install zstandard

      - name: åœ¨Windowsä¸Šç¼–è¯‘
        if: matrix.os == 'windows-2022'
        timeout-minutes: 45
        env:
          PYTHONIOENCODING: utf-8
          PYTHONLEGACYWINDOWSSTDIO: 1
        run: |
          chcp 65001
          python build_with_nuitka.py
          if (!(Test-Path "dist_nuitka/main.dist/TimeNest.exe")) {
            Write-Error "Windowså¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          }

      - name: åœ¨Linuxä¸Šç¼–è¯‘
        if: matrix.os == 'ubuntu-latest'
        timeout-minutes: 45
        run: |
          python build_with_nuitka.py
          if [ ! -f "dist_nuitka/main.dist/TimeNest" ]; then
            echo "Linuxå¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          chmod +x dist_nuitka/main.dist/TimeNest

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        id: prepare_release
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            Compress-Archive -Path dist_nuitka/main.dist/* -DestinationPath TimeNest-windows.zip
          else
            cd dist_nuitka/main.dist
            tar -czvf ../../TimeNest-linux.tar.gz *
            cd ../..
          fi
        shell: bash

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: TimeNest-${{
            runner.os }}-${{ github.run_number }}
          path: ${{
            runner.os == 'Windows' &&
            'TimeNest-windows.zip' || 'TimeNest-linux.tar.gz' }}
          if-no-files-found: error
          retention-days: 30

      - name: æ„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "## æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- æ“ä½œç³»ç»Ÿ: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ„å»ºçŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "- âœ… æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            if [ "${{ runner.os }}" = "Windows" ]; then
              echo "- ğŸ“¦ Windowså¯æ‰§è¡Œæ–‡ä»¶å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ğŸ“¦ Linuxå¯æ‰§è¡Œæ–‡ä»¶å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: å‘å¸ƒå‘è¡Œç‰ˆ
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            TimeNest-windows.zip
            TimeNest-linux.tar.gz
          name: Release ${{ github.ref_name }}
          body: |
            è‡ªåŠ¨æ„å»ºçš„TimeNeståº”ç”¨ç¨‹åº

            ## æ„å»ºä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{
                github.event.head_commit.timestamp || github.event.created_at }}
            - æäº¤: ${{ github.sha }}
            - Pythonç‰ˆæœ¬: 3.11
            - Nuitkaç‰ˆæœ¬: 2.4.11

            ## ä¸‹è½½è¯´æ˜
            - Windowsç”¨æˆ·è¯·ä¸‹è½½ `TimeNest-windows.zip`
            - Linuxç”¨æˆ·è¯·ä¸‹è½½ `TimeNest-linux.tar.gz`

            ## ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å‹ç¼©åŒ…
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. è¿è¡Œä¸»ç¨‹åºå³å¯
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
