---
name: è‡ªåŠ¨ç¼–è¯‘å’Œå‘å¸ƒ

'on':
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.os == 'windows-2022' && 60 || 30 }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, ubuntu-latest]
        include:
          - os: windows-2022
            timeout: 60
          - os: ubuntu-latest
            timeout: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ç¼“å­˜Nuitkaæž„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.cache/Nuitka
          key: ${{ runner.os }}-nuitka-${{
            hashFiles('**/build_with_nuitka.py', '**/main.py') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka==2.4.11
          pip install ordered-set
          pip install zstandard

      - name: åœ¨Windowsä¸Šç¼–è¯‘
        if: matrix.os == 'windows-2022'
        timeout-minutes: 45
        env:
          PYTHONIOENCODING: utf-8
          PYTHONLEGACYWINDOWSSTDIO: 1
        run: |
          chcp 65001
          python build_with_nuitka.py
          if (!(Test-Path "dist_nuitka/main.dist/TimeNest.exe")) {
            Write-Error "Windowså¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          }

      - name: åœ¨Linuxä¸Šç¼–è¯‘
        if: matrix.os == 'ubuntu-latest'
        timeout-minutes: 45
        run: |
          python build_with_nuitka.py
          if [ ! -f "dist_nuitka/main.dist/TimeNest" ]; then
            echo "Linuxå¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          chmod +x dist_nuitka/main.dist/TimeNest

      - name: å‡†å¤‡Windowså‘å¸ƒæ–‡ä»¶
        if: runner.os == 'Windows'
        run: |
          7z a TimeNest-windows.zip dist_nuitka/main.dist/*
        shell: cmd

      - name: å‡†å¤‡Linuxå‘å¸ƒæ–‡ä»¶
        if: runner.os == 'Linux'
        run: |
          cd dist_nuitka/main.dist
          tar -czvf ../../TimeNest-linux.tar.gz *
          cd ../..
        shell: bash

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: TimeNest-${{
            runner.os }}-${{ github.run_number }}
          path: ${{
            runner.os == 'Windows' &&
            'TimeNest-windows.zip' || 'TimeNest-linux.tar.gz' }}
          if-no-files-found: error
          retention-days: 30

      - name: æž„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "## æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- æ“ä½œç³»ç»Ÿ: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºçŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "- âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            if [ "${{ runner.os }}" = "Windows" ]; then
              echo "- ðŸ“¦ Windowså¯æ‰§è¡Œæ–‡ä»¶å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ðŸ“¦ Linuxå¯æ‰§è¡Œæ–‡ä»¶å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âŒ æž„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash
