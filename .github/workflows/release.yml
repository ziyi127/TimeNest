name: Build and Release

on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾æ—¶è§¦å‘å‘å¸ƒ
    branches: [ main, develop ]  # æ¨é€åˆ°åˆ†æ”¯æ—¶åªæ„å»ºï¼Œä¸å‘å¸ƒ
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Convert PNG to ICO (if needed)
      run: |
        if (!(Test-Path "resources\icons\tray_icon.ico")) {
          echo "Converting PNG to ICO format..."
          # å¦‚æœæ²¡æœ‰icoæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨åœ¨çº¿è½¬æ¢æˆ–å…¶ä»–å·¥å…·
          # è¿™é‡Œå…ˆè·³è¿‡ï¼Œä½¿ç”¨PNGæ–‡ä»¶
        }
        
    - name: Set UTF-8 encoding
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
      shell: pwsh

    - name: Build executable with spec
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"

        if (Test-Path "TimeNest.spec") {
          echo "Building with spec file..."
          pyinstaller TimeNest.spec --clean --noconfirm
        } elseif (Test-Path "build_simple.py") {
          echo "Using simple build script..."
          python build_simple.py
        } else {
          echo "Using fallback build script..."
          python build_fallback.py
        }
      shell: pwsh
        
    - name: Create portable package
      run: |
        mkdir TimeNest-portable
        copy dist\TimeNest.exe TimeNest-portable\
        copy README.md TimeNest-portable\
        copy LICENSE TimeNest-portable\
        if (Test-Path "config") { xcopy /E /I config TimeNest-portable\config }
        if (Test-Path "resources") { xcopy /E /I resources TimeNest-portable\resources }
        if (Test-Path "themes") { xcopy /E /I themes TimeNest-portable\themes }
        if (Test-Path "schedule_template.xlsx") { copy schedule_template.xlsx TimeNest-portable\ }
        
    - name: Create ZIP archive
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          Compress-Archive -Path TimeNest-portable\* -DestinationPath TimeNest-${{ github.ref_name }}-windows.zip
        } elseif ("${{ github.ref_name }}" -eq "main") {
          # ä»app_info.jsonè¯»å–ç‰ˆæœ¬ä¿¡æ¯ç”¨äºæ–‡ä»¶å
          $appInfo = Get-Content app_info.json | ConvertFrom-Json
          $version = $appInfo.version.number
          Compress-Archive -Path TimeNest-portable\* -DestinationPath TimeNest-v$version-windows.zip
        } else {
          Compress-Archive -Path TimeNest-portable\* -DestinationPath TimeNest-${{ github.sha }}-windows.zip
        }

    - name: Get release info
      id: release_info
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        } else {
          # ä»app_info.jsonè¯»å–ç‰ˆæœ¬ä¿¡æ¯
          $appInfo = Get-Content app_info.json | ConvertFrom-Json
          $version = $appInfo.version.number
          $tag = "v$version"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT

    - name: Create Release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        name: TimeNest ${{ steps.release_info.outputs.version }}
        body: |
          ## TimeNest ${{ steps.release_info.outputs.version }}

          ### ğŸ“¦ ä¸‹è½½
          - **Windows ä¾¿æºç‰ˆ**: TimeNest-${{ steps.release_info.outputs.tag }}-windows.zip

          ### ğŸš€ æ–°åŠŸèƒ½
          - ğŸ”§ UIç»„ä»¶ä¿®å¤ï¼šä¿®å¤äº†RinUIç»„ä»¶ä½¿ç”¨é—®é¢˜ï¼Œæ‰€æœ‰é¡µé¢ç°åœ¨æ­£å¸¸æ˜¾ç¤º
          - âš™ï¸ è®¾ç½®é¡µé¢ä¼˜åŒ–ï¼šä½¿ç”¨åŸç”ŸSettingCardç»„ä»¶ï¼Œæä¾›æ›´å¥½çš„è®¾ç½®ä½“éªŒ
          - ğŸ¨ ç•Œé¢ç¨³å®šæ€§ï¼šè§£å†³äº†é¡µé¢ç©ºç™½å’Œç»„ä»¶å†²çªé—®é¢˜
          - ğŸ“± å“åº”å¼å¸ƒå±€ï¼šä¼˜åŒ–äº†ScrollViewå’Œå¸ƒå±€ç³»ç»Ÿ

          ### ğŸ› ä¿®å¤
          - ğŸš€ æ€§èƒ½æå‡ï¼šç§»é™¤äº†å†²çªçš„è‡ªå®šä¹‰ç»„ä»¶ï¼Œæå‡è¿è¡Œç¨³å®šæ€§
          - ä¿®å¤RinUIç»„ä»¶å±æ€§é”™è¯¯å¯¼è‡´çš„æ˜¾ç¤ºé—®é¢˜
          - ä¼˜åŒ–é¡µé¢å¸ƒå±€å’Œç»„ä»¶å®šä½é€»è¾‘

          ### ğŸ“‹ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ TimeNest.exe

          ### ğŸ’¡ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11
          - Python 3.8+ (å¦‚æœä»æºç è¿è¡Œ)
          - RinUI æ¡†æ¶æ”¯æŒ

          ### âš ï¸ æ³¨æ„äº‹é¡¹
          è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°çš„ RinUI ç•Œé¢æ”¹è¿›ã€‚å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­å…ˆè¡Œä½“éªŒã€‚
        draft: false
        prerelease: ${{ contains(steps.release_info.outputs.version, 'Preview') || contains(steps.release_info.outputs.version, 'Beta') || contains(steps.release_info.outputs.version, 'RC') }}
        files: |
          TimeNest-${{ steps.release_info.outputs.tag }}-windows.zip

    - name: Upload Build Artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-windows
        path: TimeNest-${{ github.sha }}-windows.zip
        retention-days: 30