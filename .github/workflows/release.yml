name: Build and Release

on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾æ—¶è§¦å‘å‘å¸ƒ
    branches: [ main ]  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨åˆ›å»ºrelease
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Convert PNG to ICO (if needed)
      run: |
        if (!(Test-Path "resources\icons\tray_icon.ico")) {
          echo "Converting PNG to ICO format..."
          # å¦‚æœæ²¡æœ‰icoæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨åœ¨çº¿è½¬æ¢æˆ–å…¶ä»–å·¥å…·
          # è¿™é‡Œå…ˆè·³è¿‡ï¼Œä½¿ç”¨PNGæ–‡ä»¶
        }
        
    - name: Set UTF-8 encoding
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
      shell: pwsh

    - name: Build executable with spec
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"

        echo "Building with onedir mode..."
        python -m PyInstaller --noconfirm --onedir --windowed --icon TKtimetable.ico --name TimeNest --add-data "timetable.json;." --add-data "TKtimetable.ico;." --hidden-import tkinter --hidden-import PIL --hidden-import pystray main.py
      shell: pwsh
        
    - name: Create portable package
      run: |
        mkdir TimeNest-portable
        xcopy /E /I dist\TimeNest TimeNest-portable\
        copy README.md TimeNest-portable\
        copy LICENSE TimeNest-portable\
        if (Test-Path "config") { xcopy /E /I config TimeNest-portable\config }
        if (Test-Path "resources") { xcopy /E /I resources TimeNest-portable\resources }
        if (Test-Path "themes") { xcopy /E /I themes TimeNest-portable\themes }
        if (Test-Path "schedule_template.xlsx") { copy schedule_template.xlsx TimeNest-portable\ }
        
    - name: Create Windows installer and package
      run: |
        $version = "${{ steps.release_info.outputs.version }}"
        $arch = "${{ steps.release_info.outputs.architecture }}"

        # å®‰è£…NSIS for creating exe installer
        choco install nsis -y
        $env:PATH += ";C:\Program Files (x86)\NSIS"

        # åˆ›å»ºNSISå®‰è£…è„šæœ¬
        $nsisScript = @"
        !define APP_NAME "TimeNest"
        !define APP_VERSION "$version"
        !define APP_ARCH "$arch"
        !define PUBLISHER "ziyi127"
        !define WEB_SITE "https://timenest.qzz.io"
        !define INSTALL_DIR "`$PROGRAMFILES64\TimeNest"

        Name "`${APP_NAME} `${APP_VERSION}"
        OutFile "TimeNest_`${APP_VERSION}_`${APP_ARCH}.exe"
        InstallDir "`${INSTALL_DIR}"

        Page directory
        Page instfiles

        Section "MainSection" SEC01
            SetOutPath "`$INSTDIR"
            File /r "TimeNest-portable\*"
            CreateDirectory "`$SMPROGRAMS\TimeNest"
            CreateShortCut "`$SMPROGRAMS\TimeNest\TimeNest.lnk" "`$INSTDIR\TimeNest.exe"
            CreateShortCut "`$DESKTOP\TimeNest.lnk" "`$INSTDIR\TimeNest.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TimeNest" "DisplayName" "TimeNest"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TimeNest" "UninstallString" "`$INSTDIR\uninstall.exe"
            WriteUninstaller "`$INSTDIR\uninstall.exe"
        SectionEnd

        Section "Uninstall"
            Delete "`$INSTDIR\*.*"
            RMDir /r "`$INSTDIR"
            Delete "`$SMPROGRAMS\TimeNest\*.*"
            RMDir "`$SMPROGRAMS\TimeNest"
            Delete "`$DESKTOP\TimeNest.lnk"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TimeNest"
        SectionEnd
        "@

        $nsisScript | Out-File -FilePath "installer.nsi" -Encoding UTF8

        # ç¼–è¯‘å®‰è£…ç¨‹åº
        makensis installer.nsi

        # å‹ç¼©å®‰è£…ç¨‹åº
        $exeFile = "TimeNest_${version}_${arch}.exe"
        $zipFile = "TimeNest_${version}_${arch}.exe.zip"
        Compress-Archive -Path $exeFile -DestinationPath $zipFile -CompressionLevel Optimal

        echo "Created Windows installer: $zipFile"

        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        $fileInfo = Get-Item $zipFile
        $sizeMB = [math]::Round($fileInfo.Length / 1MB, 2)
        echo "Package size: $sizeMB MB"

    - name: Get release info and architecture
      id: release_info
      run: |
        # ä½¿ç”¨matrixæ¶æ„
        $archName = "${{ matrix.arch }}"
        echo "architecture=$archName" >> $env:GITHUB_OUTPUT

        if ("${{ github.ref_type }}" -eq "tag") {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        } else {
          # ä»app_info.jsonè¯»å–ç‰ˆæœ¬ä¿¡æ¯
          $appInfo = Get-Content app_info.json | ConvertFrom-Json
          $version = $appInfo.version.number
          $tag = "v$version"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT

    - name: Upload Windows package to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        name: TimeNest ${{ steps.release_info.outputs.version }}
        body: |
          ## TimeNest ${{ steps.release_info.outputs.version }}

          ### ğŸ“¦ Windows ä¸‹è½½
          - **Windows å®‰è£…ç¨‹åº**: TimeNest_${{ steps.release_info.outputs.version }}_${{ steps.release_info.outputs.architecture }}.exe.zip

          ### ğŸ“‹ Windows å®‰è£…è¯´æ˜
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. è§£å‹å¾—åˆ° `.exe` å®‰è£…ç¨‹åº
          3. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
          4. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…

          ### ğŸ’¡ ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ¶æ„: ${{ matrix.arch }}

          ### ğŸš€ è¿è¡Œ
          å®‰è£…å®Œæˆåï¼Œå¯ä»¥ä»å¼€å§‹èœå•æˆ–æ¡Œé¢å¿«æ·æ–¹å¼å¯åŠ¨ TimeNestã€‚
        draft: false
        prerelease: ${{ contains(steps.release_info.outputs.version, 'Preview') || contains(steps.release_info.outputs.version, 'Beta') || contains(steps.release_info.outputs.version, 'RC') }}
        files: |
          TimeNest_${{ steps.release_info.outputs.version }}_${{ steps.release_info.outputs.architecture }}.exe.zip

    - name: Upload Build Artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-windows-${{ matrix.arch }}
        path: TimeNest_${{ steps.release_info.outputs.version }}_${{ steps.release_info.outputs.architecture }}.exe.zip
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64]  # ç§»é™¤arm64ï¼Œå› ä¸ºGitHub Actionsä¸æ”¯æŒçœŸæ­£çš„ARM64äº¤å‰ç¼–è¯‘

    steps:
    - name: Checkout code
      uses: actions/checkout@v4



    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          python3-tk \
          build-essential \
          fakeroot \
          devscripts \
          debhelper \
          dh-python \
          rpm \
          alien \
          git \
          desktop-file-utils \
          qt6-base-dev \
          qt6-tools-dev \
          libgl1-mesa-dev \
          libegl1-mesa-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # å®‰è£…åŸºç¡€ä¾èµ–
        pip install pyinstaller
        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼Œå¿½ç•¥å¯èƒ½çš„é”™è¯¯
        pip install -r requirements.txt || echo "Some dependencies may have failed, continuing..."
        # ç¡®ä¿å…³é”®ä¾èµ–å·²å®‰è£…
        pip install PySide6 PyYAML requests pandas numpy openpyxl

    - name: Build Linux executable
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export QT_QPA_PLATFORM=offscreen
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        export DISPLAY=:99

        # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºï¼ˆå¦‚æœéœ€è¦ï¼‰
        sudo apt-get install -y xvfb || true
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

        # æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        python -m PyInstaller --noconfirm --onedir --windowed --icon TKtimetable.ico --name TimeNest --add-data "timetable.json:." --add-data "TKtimetable.ico:." --hidden-import tkinter --hidden-import PIL --hidden-import pystray main.py



    - name: Get version info and architecture
      id: version_info
      run: |
        # ä½¿ç”¨matrixæ¶æ„
        ARCH_NAME="${{ matrix.arch }}"
        echo "architecture=$ARCH_NAME" >> $GITHUB_OUTPUT

        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
        else
          VERSION=$(python -c "import json; print(json.load(open('app_info.json'))['version']['number'])")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    - name: Create application directory structure
      run: |
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/bin
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/applications
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/pixmaps
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/TimeNest

        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp -r dist/TimeNest/* TimeNest-${{ steps.version_info.outputs.version }}/usr/bin/
        chmod +x TimeNest-${{ steps.version_info.outputs.version }}/usr/bin/TimeNest

        # åˆ›å»ºæ¡Œé¢æ–‡ä»¶
        cat > TimeNest-${{ steps.version_info.outputs.version }}/usr/share/applications/TimeNest.desktop << EOF
        [Desktop Entry]
        Name=TimeNest
        Comment=æ™ºèƒ½æ—¶é—´ç®¡ç†åŠ©æ‰‹
        Exec=TimeNest
        Icon=TimeNest
        Terminal=false
        Type=Application
        Categories=Office;Utility;
        StartupNotify=true
        EOF

        # å¤åˆ¶å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "resources/app_icon.png" ]; then
          cp resources/app_icon.png TimeNest-${{ steps.version_info.outputs.version }}/usr/share/pixmaps/TimeNest.png
        fi

        # å¤åˆ¶æ–‡æ¡£
        cp README.md TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/TimeNest/
        cp LICENSE TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/TimeNest/ || echo "LICENSE file not found"

    - name: Install Linux packaging tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev rpm build-essential fakeroot

    - name: Create Linux native packages
      run: |
        chmod +x scripts/build_linux_packages.sh
        ./scripts/build_linux_packages.sh ${{ steps.version_info.outputs.version }} ${{ steps.version_info.outputs.architecture }}






    - name: Upload Linux packages to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version_info.outputs.tag }}
        name: TimeNest ${{ steps.version_info.outputs.version }}
        body: |
          ## TimeNest ${{ steps.version_info.outputs.version }} - Linux å®‰è£…åŒ…

          ### ğŸ“¦ Linux ä¸‹è½½
          - **ä¾¿æºç‰ˆ**: TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.tar.gz

          ### ğŸ“‹ å®‰è£…è¯´æ˜

          **ä¾¿æºç‰ˆä½¿ç”¨:**
          ```bash
          # è§£å‹æ–‡ä»¶
          tar -xzf TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.tar.gz

          # è¿›å…¥ç›®å½•
          cd TimeNest-portable-linux

          # è¿è¡Œç¨‹åº
          ./run.sh
          # æˆ–ç›´æ¥è¿è¡Œ
          ./TimeNest
          ```

          ### ğŸ’¡ ç³»ç»Ÿè¦æ±‚
          - Linux å‘è¡Œç‰ˆï¼ˆUbuntu 18.04+ã€CentOS 7+ã€Debian 10+ ç­‰ï¼‰
          - æ¶æ„: ${{ matrix.arch }}
          - Python 3.8+ è¿è¡Œæ—¶ç¯å¢ƒ

          ### ğŸš€ è¿è¡Œ
          è§£å‹åå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯åŠ¨ï¼š
          - ä½¿ç”¨å¯åŠ¨è„šæœ¬: `./run.sh`
          - ç›´æ¥è¿è¡Œ: `./TimeNest`
        draft: false
        prerelease: ${{ contains(steps.version_info.outputs.version, 'Preview') || contains(steps.version_info.outputs.version, 'Beta') || contains(steps.version_info.outputs.version, 'RC') }}
        files: |
          TimeNest_${{ steps.version_info.outputs.version }}_x86_64.deb.zip
          TimeNest_${{ steps.version_info.outputs.version }}_x86_64.rpm.zip
          TimeNest_${{ steps.version_info.outputs.version }}_x86_64.pkg.zip

    - name: Upload Linux artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-linux-${{ matrix.arch }}
        path: |
          TimeNest_${{ steps.version_info.outputs.version }}_x86_64.deb.zip
          TimeNest_${{ steps.version_info.outputs.version }}_x86_64.rpm.zip
          TimeNest_${{ steps.version_info.outputs.version }}_x86_64.pkg.zip
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # å®‰è£…åŸºç¡€ä¾èµ–
        pip install pyinstaller
        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼Œå¿½ç•¥å¯èƒ½çš„é”™è¯¯
        pip install -r requirements.txt || echo "Some dependencies may have failed, continuing..."
        # ç¡®ä¿å…³é”®ä¾èµ–å·²å®‰è£…
        pip install PySide6 PyYAML requests pandas numpy openpyxl

    - name: Build macOS executable
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PYTHONPATH=$PYTHONPATH:$(pwd)

        # æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        python -m PyInstaller --noconfirm --onedir --windowed --icon TKtimetable.ico --name TimeNest --add-data "timetable.json:." --add-data "TKtimetable.ico:." --hidden-import tkinter --hidden-import PIL --hidden-import pystray main.py

    - name: Get version info and architecture
      id: version_info_macos
      run: |
        # ä½¿ç”¨matrixæ¶æ„
        ARCH_NAME="${{ matrix.arch }}"
        echo "architecture=$ARCH_NAME" >> $GITHUB_OUTPUT

        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
        else
          VERSION=$(python -c "import json; print(json.load(open('app_info.json'))['version']['number'])")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    - name: Create macOS DMG package
      run: |
        VERSION=${{ steps.version_info_macos.outputs.version }}
        ARCH="${{ steps.version_info_macos.outputs.architecture }}"

        # åˆ›å»ºåº”ç”¨ç¨‹åºåŒ…ç»“æ„
        mkdir -p TimeNest.app/Contents/MacOS
        mkdir -p TimeNest.app/Contents/Resources

        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp -r dist/TimeNest/* TimeNest.app/Contents/MacOS/
        chmod +x TimeNest.app/Contents/MacOS/TimeNest

        # åˆ›å»ºInfo.plistæ–‡ä»¶
        cat > TimeNest.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>TimeNest</string>
            <key>CFBundleIdentifier</key>
            <string>com.ziyi127.TimeNest</string>
            <key>CFBundleName</key>
            <string>TimeNest</string>
            <key>CFBundleVersion</key>
            <string>$VERSION</string>
            <key>CFBundleShortVersionString</key>
            <string>$VERSION</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleSignature</key>
            <string>????</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSHumanReadableCopyright</key>
            <string>Copyright Â© 2025 ziyi127. All rights reserved.</string>
        </dict>
        </plist>
        EOF

        # å¤åˆ¶å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "resources/app_icon.png" ]; then
          cp resources/app_icon.png TimeNest.app/Contents/Resources/app_icon.png
        fi

        # åˆ›å»ºDMGç£ç›˜æ˜ åƒ
        echo "Creating DMG disk image..."

        # åˆ›å»ºä¸´æ—¶DMGç›®å½•
        mkdir -p dmg-temp
        cp -r TimeNest.app dmg-temp/

        # åˆ›å»ºApplicationsé“¾æ¥
        ln -s /Applications dmg-temp/Applications

        # åˆ›å»ºDMGæ–‡ä»¶
        hdiutil create -volname "TimeNest" -srcfolder dmg-temp -ov -format UDZO TimeNest_${VERSION}_${ARCH}.dmg

        # å‹ç¼©DMGæ–‡ä»¶
        zip TimeNest_${VERSION}_${ARCH}.dmg.zip TimeNest_${VERSION}_${ARCH}.dmg

        echo "Created macOS DMG package: TimeNest_${VERSION}_${ARCH}.dmg.zip"

        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        ls -lh "TimeNest_${VERSION}_${ARCH}.dmg.zip"

    - name: Upload macOS package to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version_info_macos.outputs.tag }}
        name: TimeNest ${{ steps.version_info_macos.outputs.version }}
        body: |
          ## TimeNest ${{ steps.version_info_macos.outputs.version }} - macOS ç‰ˆæœ¬

          ### ğŸ“¦ macOS ä¸‹è½½
          - **macOS åº”ç”¨ç¨‹åº**: TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}.zip

          ### ğŸ“‹ macOS å®‰è£…è¯´æ˜
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. è§£å‹ ZIP æ–‡ä»¶
          3. å°† TimeNest.app æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
          4. åœ¨ Applications ä¸­æ‰¾åˆ° TimeNest å¹¶å¯åŠ¨

          ### ğŸ’¡ ç³»ç»Ÿè¦æ±‚
          - macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ¶æ„: ${{ matrix.arch }}

          ### âš ï¸ æ³¨æ„äº‹é¡¹
          é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½®" > "å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œæ­¤åº”ç”¨ç¨‹åºã€‚
        draft: false
        prerelease: ${{ contains(steps.version_info_macos.outputs.version, 'Preview') || contains(steps.version_info_macos.outputs.version, 'Beta') || contains(steps.version_info_macos.outputs.version, 'RC') }}
        files: |
          TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}.dmg.zip

    - name: Upload macOS artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-macos-${{ matrix.arch }}
        path: |
          TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}.dmg.zip
        retention-days: 30