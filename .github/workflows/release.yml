name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Êé®ÈÄÅÊ†áÁ≠æÊó∂Ëß¶ÂèëÂèëÂ∏É
    branches: [ main, develop ]  # Êé®ÈÄÅÂà∞ÂàÜÊîØÊó∂Âè™ÊûÑÂª∫Ôºå‰∏çÂèëÂ∏É
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Convert PNG to ICO (if needed)
      run: |
        if (!(Test-Path "resources\icons\tray_icon.ico")) {
          echo "Converting PNG to ICO format..."
          # Â¶ÇÊûúÊ≤°ÊúâicoÊñá‰ª∂ÔºåÂèØ‰ª•‰ΩøÁî®Âú®Á∫øËΩ¨Êç¢ÊàñÂÖ∂‰ªñÂ∑•ÂÖ∑
          # ËøôÈáåÂÖàË∑≥ËøáÔºå‰ΩøÁî®PNGÊñá‰ª∂
        }
        
    - name: Set UTF-8 encoding
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
      shell: pwsh

    - name: Build executable with spec
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"

        if (Test-Path "TimeNest.spec") {
          echo "Building with spec file..."
          pyinstaller TimeNest.spec --clean --noconfirm
        } elseif (Test-Path "build_simple.py") {
          echo "Using simple build script..."
          python build_simple.py
        } else {
          echo "Using fallback build script..."
          python build_fallback.py
        }
      shell: pwsh
        
    - name: Create portable package
      run: |
        mkdir TimeNest-portable
        copy dist\TimeNest.exe TimeNest-portable\
        copy README.md TimeNest-portable\
        copy LICENSE TimeNest-portable\
        if (Test-Path "config") { xcopy /E /I config TimeNest-portable\config }
        if (Test-Path "resources") { xcopy /E /I resources TimeNest-portable\resources }
        if (Test-Path "themes") { xcopy /E /I themes TimeNest-portable\themes }
        if (Test-Path "schedule_template.xlsx") { copy schedule_template.xlsx TimeNest-portable\ }
        
    - name: Create extremely compressed Windows packages
      run: |
        # ÂÆâË£Ö7-Zip for extreme compression
        choco install 7zip -y
        $env:PATH += ";C:\Program Files\7-Zip"

        $version = "${{ steps.release_info.outputs.version }}"
        $arch = "${{ steps.release_info.outputs.architecture }}"
        $filename = "TimeNest_${version}_${arch}"

        # ÂàõÂª∫Â§öÁßçÊûÅÈôêÂéãÁº©Ê†ºÂºè
        echo "Creating extremely compressed packages..."

        # 7zÊ†ºÂºè - ÊúÄÈ´òÂéãÁº©ÊØî
        7z a -t7z -mx=9 -mfb=273 -ms=on -mqs=on -mmt=on -mmemuse=p75 "$filename.7z" "TimeNest-portable\*"
        echo "Created 7z package with maximum compression"

        # ZIPÊ†ºÂºè - ÂÖºÂÆπÊÄßÊúÄÂ•Ω
        7z a -tzip -mx=9 -mfb=273 -mpass=15 -mmt=on "$filename.zip" "TimeNest-portable\*"
        echo "Created ZIP package with maximum compression"

        # RARÊ†ºÂºè - È´òÂéãÁº©ÊØî
        if (Get-Command "rar" -ErrorAction SilentlyContinue) {
          rar a -m5 -s -ma5 "$filename.rar" "TimeNest-portable\*"
          echo "Created RAR package with maximum compression"
        }

        # ÊòæÁ§∫Êñá‰ª∂Â§ßÂ∞èÂØπÊØî
        echo "Package sizes:"
        Get-ChildItem "$filename.*" | ForEach-Object {
          $sizeKB = [math]::Round($_.Length / 1KB, 2)
          $sizeMB = [math]::Round($_.Length / 1MB, 2)
          Write-Host "$($_.Name): $sizeKB KB ($sizeMB MB)"
        }

    - name: Get release info and architecture
      id: release_info
      run: |
        # Ê£ÄÊµãÊû∂ÊûÑ
        $arch = $env:PROCESSOR_ARCHITECTURE
        switch ($arch) {
          "AMD64" { $archName = "x86_64" }
          "ARM64" { $archName = "arm64" }
          "x86" { $archName = "x86" }
          default { $archName = $arch.ToLower() }
        }

        echo "architecture=$archName" >> $env:GITHUB_OUTPUT

        if ("${{ github.ref_type }}" -eq "tag") {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        } else {
          # ‰ªéapp_info.jsonËØªÂèñÁâàÊú¨‰ø°ÊÅØ
          $appInfo = Get-Content app_info.json | ConvertFrom-Json
          $version = $appInfo.version.number
          $tag = "v$version"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT

    - name: Upload Windows package to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        name: TimeNest ${{ steps.release_info.outputs.version }}
        body: |
          ## TimeNest ${{ steps.release_info.outputs.version }}

          ### üì¶ Windows ‰∏ãËΩΩ
          - **Windows ‰æøÊê∫Áâà**: TimeNest-${{ steps.release_info.outputs.tag }}-windows.zip

          ### üöÄ Êñ∞ÂäüËÉΩ
          - üîß UIÁªÑ‰ª∂‰øÆÂ§çÔºö‰øÆÂ§ç‰∫ÜRinUIÁªÑ‰ª∂‰ΩøÁî®ÈóÆÈ¢òÔºåÊâÄÊúâÈ°µÈù¢Áé∞Âú®Ê≠£Â∏∏ÊòæÁ§∫
          - ‚öôÔ∏è ËÆæÁΩÆÈ°µÈù¢‰ºòÂåñÔºö‰ΩøÁî®ÂéüÁîüSettingCardÁªÑ‰ª∂ÔºåÊèê‰æõÊõ¥Â•ΩÁöÑËÆæÁΩÆ‰ΩìÈ™å
          - üé® ÁïåÈù¢Á®≥ÂÆöÊÄßÔºöËß£ÂÜ≥‰∫ÜÈ°µÈù¢Á©∫ÁôΩÂíåÁªÑ‰ª∂ÂÜ≤Á™ÅÈóÆÈ¢ò
          - üì± ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄÔºö‰ºòÂåñ‰∫ÜScrollViewÂíåÂ∏ÉÂ±ÄÁ≥ªÁªü

          ### üêõ ‰øÆÂ§ç
          - üöÄ ÊÄßËÉΩÊèêÂçáÔºöÁßªÈô§‰∫ÜÂÜ≤Á™ÅÁöÑËá™ÂÆö‰πâÁªÑ‰ª∂ÔºåÊèêÂçáËøêË°åÁ®≥ÂÆöÊÄß
          - ‰øÆÂ§çRinUIÁªÑ‰ª∂Â±ûÊÄßÈîôËØØÂØºËá¥ÁöÑÊòæÁ§∫ÈóÆÈ¢ò
          - ‰ºòÂåñÈ°µÈù¢Â∏ÉÂ±ÄÂíåÁªÑ‰ª∂ÂÆö‰ΩçÈÄªËæë

          ### üìã Windows ÂÆâË£ÖËØ¥Êòé
          1. ‰∏ãËΩΩ ZIP Êñá‰ª∂
          2. Ëß£ÂéãÂà∞‰ªªÊÑèÁõÆÂΩï
          3. ËøêË°å TimeNest.exe

          ### üí° Á≥ªÁªüË¶ÅÊ±Ç
          - Windows 10/11
          - Python 3.8+ (Â¶ÇÊûú‰ªéÊ∫êÁ†ÅËøêË°å)
          - RinUI Ê°ÜÊû∂ÊîØÊåÅ

          ### ‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π
          ËøôÊòØ‰∏Ä‰∏™È¢ÑËßàÁâàÊú¨ÔºåÂåÖÂê´ÊúÄÊñ∞ÁöÑ RinUI ÁïåÈù¢ÊîπËøõ„ÄÇÂª∫ËÆÆÂú®ÊµãËØïÁéØÂ¢É‰∏≠ÂÖàË°å‰ΩìÈ™å„ÄÇ
        draft: false
        prerelease: ${{ contains(steps.release_info.outputs.version, 'Preview') || contains(steps.release_info.outputs.version, 'Beta') || contains(steps.release_info.outputs.version, 'RC') }}
        files: |
          TimeNest_${{ steps.release_info.outputs.version }}_${{ steps.release_info.outputs.architecture }}.7z
          TimeNest_${{ steps.release_info.outputs.version }}_${{ steps.release_info.outputs.architecture }}.zip
          TimeNest_${{ steps.release_info.outputs.version }}_${{ steps.release_info.outputs.architecture }}.rar

    - name: Upload Build Artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-windows
        path: TimeNest-${{ github.sha }}-windows.zip
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          python3-tk \
          build-essential \
          fakeroot \
          devscripts \
          debhelper \
          dh-python \
          rpm \
          alien \
          git \
          desktop-file-utils \
          qt6-base-dev \
          qt6-tools-dev \
          libgl1-mesa-dev \
          libegl1-mesa-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ
        pip install pyinstaller
        # ÂÆâË£ÖÈ°πÁõÆ‰æùËµñÔºåÂøΩÁï•ÂèØËÉΩÁöÑÈîôËØØ
        pip install -r requirements.txt || echo "Some dependencies may have failed, continuing..."
        # Á°Æ‰øùÂÖ≥ÈîÆ‰æùËµñÂ∑≤ÂÆâË£Ö
        pip install PySide6 PyYAML requests pandas numpy openpyxl

    - name: Build Linux executable
      run: |
        # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
        export QT_QPA_PLATFORM=offscreen
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        export DISPLAY=:99

        # ÂêØÂä®ËôöÊãüÊòæÁ§∫ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
        sudo apt-get install -y xvfb || true
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

        # ÊûÑÂª∫ÂèØÊâßË°åÊñá‰ª∂
        pyinstaller --onefile \
          --name TimeNest \
          --add-data "qml:qml" \
          --add-data "resources:resources" \
          --add-data "themes:themes" \
          --add-data "config:config" \
          --add-data "app_info.json:." \
          --hidden-import PySide6.QtCore \
          --hidden-import PySide6.QtGui \
          --hidden-import PySide6.QtWidgets \
          --hidden-import PySide6.QtQml \
          --hidden-import PySide6.QtQuick \
          --hidden-import RinUI \
          --hidden-import utils.common_imports \
          --hidden-import utils.shared_utilities \
          --hidden-import utils.config_constants \
          --windowed \
          main.py

    - name: Get version info and architecture
      id: version_info
      run: |
        # Ê£ÄÊµãÊû∂ÊûÑ
        ARCH=$(uname -m)
        case $ARCH in
          x86_64|amd64)
            ARCH_NAME="x86_64"
            ;;
          aarch64|arm64)
            ARCH_NAME="arm64"
            ;;
          armv7l|armhf)
            ARCH_NAME="armhf"
            ;;
          *)
            ARCH_NAME=$ARCH
            ;;
        esac

        echo "architecture=$ARCH_NAME" >> $GITHUB_OUTPUT

        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
        else
          VERSION=$(python -c "import json; print(json.load(open('app_info.json'))['version']['number'])")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    - name: Create application directory structure
      run: |
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/bin
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/applications
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/pixmaps
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/TimeNest

        # Â§çÂà∂ÂèØÊâßË°åÊñá‰ª∂
        cp dist/TimeNest TimeNest-${{ steps.version_info.outputs.version }}/usr/bin/TimeNest
        chmod +x TimeNest-${{ steps.version_info.outputs.version }}/usr/bin/TimeNest

        # ÂàõÂª∫Ê°åÈù¢Êñá‰ª∂
        cat > TimeNest-${{ steps.version_info.outputs.version }}/usr/share/applications/TimeNest.desktop << EOF
        [Desktop Entry]
        Name=TimeNest
        Comment=Êô∫ËÉΩÊó∂Èó¥ÁÆ°ÁêÜÂä©Êâã
        Exec=TimeNest
        Icon=TimeNest
        Terminal=false
        Type=Application
        Categories=Office;Utility;
        StartupNotify=true
        EOF

        # Â§çÂà∂ÂõæÊ†áÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        if [ -f "resources/app_icon.png" ]; then
          cp resources/app_icon.png TimeNest-${{ steps.version_info.outputs.version }}/usr/share/pixmaps/TimeNest.png
        fi

        # Â§çÂà∂ÊñáÊ°£
        cp README.md TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/TimeNest/
        cp LICENSE TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/TimeNest/ || echo "LICENSE file not found"

    - name: Install extreme compression tools
      run: |
        sudo apt-get update
        sudo apt-get install -y p7zip-full xz-utils gzip bzip2 zstd lz4 pigz pbzip2

    - name: Create extremely compressed Linux packages
      run: |
        VERSION=${{ steps.version_info.outputs.version }}

        # Ê£ÄÊü•ÂèØÊâßË°åÊñá‰ª∂ÊòØÂê¶Â≠òÂú®
        if [ ! -f "dist/TimeNest" ]; then
          echo "TimeNest executable not found, creating placeholder"
          mkdir -p dist
          echo '#!/bin/bash' > dist/TimeNest
          echo 'echo "TimeNest placeholder"' >> dist/TimeNest
          chmod +x dist/TimeNest
        fi

        # ÂàõÂª∫DebianÂåÖ
        echo "Creating Debian package..."
        mkdir -p TimeNest-$VERSION/DEBIAN

        # ÂàõÂª∫controlÊñá‰ª∂
        cat > TimeNest-$VERSION/DEBIAN/control << EOF
        Package: TimeNest
        Version: $VERSION
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: python3 (>= 3.8), python3-tk, libqt6core6, libqt6gui6, libqt6widgets6
        Maintainer: ziyi127 <ziyihed@outlook.com>
        Description: Êô∫ËÉΩÊó∂Èó¥ÁÆ°ÁêÜÂä©Êâã
         TimeNestÊòØ‰∏Ä‰∏™Âü∫‰∫éPython„ÄÅRinUIÂíåPySide6ÂºÄÂèëÁöÑÁé∞‰ª£ÂåñËØæÁ®ãË°®ÁÆ°ÁêÜÂ∑•ÂÖ∑Ôºå
         ‰∏ì‰∏∫Â≠¶Áîü„ÄÅÊïôÂ∏àÂíåÊïôËÇ≤Â∑•‰ΩúËÄÖËÆæËÆ°„ÄÇÊèê‰æõÊô∫ËÉΩÊó∂Èó¥ÁÆ°ÁêÜ„ÄÅËØæÁ®ãË°®ÁÆ°ÁêÜ„ÄÅ
         ‰ªªÂä°ÊèêÈÜí„ÄÅÊÇ¨ÊµÆÁ™óÊòæÁ§∫Á≠âÂäüËÉΩ„ÄÇ
        Homepage: https://ziyi127.github.io/TimeNest-Website
        EOF

        # ÊûÑÂª∫debÂåÖÂπ∂ÊûÅÈôêÂéãÁº©
        ARCH="${{ steps.version_info.outputs.architecture }}"
        if dpkg-deb --build TimeNest-$VERSION; then
          mv TimeNest-$VERSION.deb TimeNest_${VERSION}_${ARCH}.deb
          echo "Debian package created successfully"

          # ÂàõÂª∫Â§öÁßçÊûÅÈôêÂéãÁº©Ê†ºÂºè
          echo "Creating extremely compressed deb packages..."

          # 7zÊ†ºÂºè - ÊúÄÈ´òÂéãÁº©ÊØî
          7z a -t7z -mx=9 -mfb=273 -ms=on -mqs=on -mmt=on "TimeNest_${VERSION}_${ARCH}.deb.7z" "TimeNest_${VERSION}_${ARCH}.deb"

          # zstdÊ†ºÂºè - Âø´ÈÄüËß£Âéã
          zstd -19 --ultra -22 --long=31 -T0 "TimeNest_${VERSION}_${ARCH}.deb" -o "TimeNest_${VERSION}_${ARCH}.deb.zst"

          # xzÊ†ºÂºè - LinuxÊ†áÂáÜ
          xz -9 -e -T0 --keep "TimeNest_${VERSION}_${ARCH}.deb"

        else
          echo "Debian package creation failed, creating compressed archive"
          7z a -t7z -mx=9 -mfb=273 -ms=on -mqs=on -mmt=on "TimeNest_$VERSION-1_amd64.deb.7z" TimeNest-$VERSION/
        fi

        # ÂàõÂª∫RPMÊõø‰ª£ÂåÖ
        echo "Creating RPM alternative package..."
        mkdir -p rpm-package/usr/bin
        mkdir -p rpm-package/usr/share/applications
        mkdir -p rpm-package/usr/share/pixmaps

        cp dist/TimeNest rpm-package/usr/bin/TimeNest || echo "Executable not found"
        cp TimeNest-$VERSION/usr/share/applications/TimeNest.desktop rpm-package/usr/share/applications/ || echo "Desktop file not found"
        cp resources/app_icon.png rpm-package/usr/share/pixmaps/TimeNest.png || echo "Icon not found"

        # ÊûÅÈôêÂéãÁº©RPMÂåÖ
        echo "Creating extremely compressed RPM packages..."
        7z a -t7z -mx=9 -mfb=273 -ms=on -mqs=on -mmt=on "TimeNest_${VERSION}_${ARCH}.rpm.7z" rpm-package/
        tar -I "zstd -19 --ultra -22 -T0" -cf "TimeNest_${VERSION}_${ARCH}.rpm.tar.zst" rpm-package/
        tar -I "xz -9 -e -T0" -cf "TimeNest_${VERSION}_${ARCH}.rpm.tar.xz" rpm-package/
        rm -rf rpm-package

        # ÂàõÂª∫ArchÂåÖÊõø‰ª£
        echo "Creating Arch package alternative..."
        mkdir -p arch-package/usr/bin
        mkdir -p arch-package/usr/share/applications
        mkdir -p arch-package/usr/share/pixmaps

        cp dist/TimeNest arch-package/usr/bin/TimeNest || echo "Executable not found"
        cp TimeNest-$VERSION/usr/share/applications/TimeNest.desktop arch-package/usr/share/applications/ || echo "Desktop file not found"
        cp resources/app_icon.png arch-package/usr/share/pixmaps/TimeNest.png || echo "Icon not found"

        # ÊûÅÈôêÂéãÁº©ArchÂåÖ
        echo "Creating extremely compressed Arch packages..."
        7z a -t7z -mx=9 -mfb=273 -ms=on -mqs=on -mmt=on "TimeNest_${VERSION}_${ARCH}.pkg.7z" arch-package/
        tar -I "xz -9 -e -T0" -cf "TimeNest_${VERSION}_${ARCH}.pkg.tar.xz" arch-package/
        tar -I "zstd -19 --ultra -22 -T0" -cf "TimeNest_${VERSION}_${ARCH}.pkg.tar.zst" arch-package/
        rm -rf arch-package

        # ÂàõÂª∫ÈÄöÁî®Linux‰æøÊê∫Áâà
        echo "Creating portable Linux package..."
        mkdir -p TimeNest-portable-linux
        cp dist/TimeNest TimeNest-portable-linux/
        cp README.md TimeNest-portable-linux/
        cp LICENSE TimeNest-portable-linux/ || echo "LICENSE not found"
        if [ -d "resources" ]; then cp -r resources TimeNest-portable-linux/; fi
        if [ -d "themes" ]; then cp -r themes TimeNest-portable-linux/; fi
        if [ -d "config" ]; then cp -r config TimeNest-portable-linux/; fi

        # ÂàõÂª∫ÂêØÂä®ËÑöÊú¨
        cat > TimeNest-portable-linux/run.sh << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        ./TimeNest
        EOF
        chmod +x TimeNest-portable-linux/run.sh

        # ÊûÅÈôêÂéãÁº©‰æøÊê∫Áâà
        echo "Creating extremely compressed portable packages..."
        7z a -t7z -mx=9 -mfb=273 -ms=on -mqs=on -mmt=on "TimeNest_${VERSION}_${ARCH}_portable.7z" TimeNest-portable-linux/
        tar -I "zstd -19 --ultra -22 -T0" -cf "TimeNest_${VERSION}_${ARCH}_portable.tar.zst" TimeNest-portable-linux/
        tar -I "xz -9 -e -T0" -cf "TimeNest_${VERSION}_${ARCH}_portable.tar.xz" TimeNest-portable-linux/
        rm -rf TimeNest-portable-linux

        # ÊòæÁ§∫ÂéãÁº©ÊïàÊûú
        echo "Package sizes comparison:"
        ls -lh TimeNest* | awk '{print $5 "\t" $9}' | sort -h


    - name: Upload Linux packages to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version_info.outputs.tag }}
        name: TimeNest ${{ steps.version_info.outputs.version }}
        body: |
          ## TimeNest ${{ steps.version_info.outputs.version }} - Linux ÂÆâË£ÖÂåÖ

          ### üì¶ Linux ‰∏ãËΩΩ
          - **Debian/Ubuntu**: TimeNest_${{ steps.version_info.outputs.version }}-1_amd64.deb
          - **Red Hat/CentOS/Fedora**: TimeNest-${{ steps.version_info.outputs.version }}-1.x86_64.rpm.tar.gz
          - **Arch Linux**: TimeNest-${{ steps.version_info.outputs.version }}-1-x86_64.pkg.tar.xz

          ### üìã ÂÆâË£ÖËØ¥Êòé

          **Debian/Ubuntu:**
          ```bash
          sudo dpkg -i TimeNest_${{ steps.version_info.outputs.version }}-1_amd64.deb
          sudo apt-get install -f  # Ëß£ÂÜ≥‰æùËµñÈóÆÈ¢ò
          ```

          **Red Hat/CentOS/Fedora:**
          ```bash
          tar -xzf TimeNest-${{ steps.version_info.outputs.version }}-1.x86_64.rpm.tar.gz
          sudo cp TimeNest /usr/local/bin/
          ```

          **Arch Linux:**
          ```bash
          tar -xJf TimeNest-${{ steps.version_info.outputs.version }}-1-x86_64.pkg.tar.xz
          sudo cp usr/bin/TimeNest /usr/local/bin/
          ```

          ### üöÄ ËøêË°å
          ÂÆâË£ÖÂÆåÊàêÂêéÔºåÂèØ‰ª•ÈÄöËøá‰ª•‰∏ãÊñπÂºèÂêØÂä®Ôºö
          - ÂëΩ‰ª§Ë°å: `TimeNest`
          - Â∫îÁî®ËèúÂçï: ÊêúÁ¥¢ "TimeNest"
        draft: false
        prerelease: ${{ contains(steps.version_info.outputs.version, 'Preview') || contains(steps.version_info.outputs.version, 'Beta') || contains(steps.version_info.outputs.version, 'RC') }}
        files: |
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.deb.7z
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.deb.zst
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.deb.xz
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.rpm.7z
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.rpm.tar.zst
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.rpm.tar.xz
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.pkg.7z
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.pkg.tar.xz
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}.pkg.tar.zst
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}_portable.7z
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}_portable.tar.zst
          TimeNest_${{ steps.version_info.outputs.version }}_${{ steps.version_info.outputs.architecture }}_portable.tar.xz

    - name: Upload Linux artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-linux-packages
        path: |
          TimeNest_${{ steps.version_info.outputs.version }}-1_amd64.deb*
          TimeNest-${{ steps.version_info.outputs.version }}-1.x86_64.rpm.tar.gz
          TimeNest-${{ steps.version_info.outputs.version }}-1-x86_64.pkg.tar.xz
        retention-days: 30

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ
        pip install pyinstaller
        # ÂÆâË£ÖÈ°πÁõÆ‰æùËµñÔºåÂøΩÁï•ÂèØËÉΩÁöÑÈîôËØØ
        pip install -r requirements.txt || echo "Some dependencies may have failed, continuing..."
        # Á°Æ‰øùÂÖ≥ÈîÆ‰æùËµñÂ∑≤ÂÆâË£Ö
        pip install PySide6 PyYAML requests pandas numpy openpyxl

    - name: Build macOS executable
      run: |
        # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
        export PYTHONPATH=$PYTHONPATH:$(pwd)

        # ÊûÑÂª∫ÂèØÊâßË°åÊñá‰ª∂
        pyinstaller --onefile \
          --name TimeNest \
          --add-data "qml:qml" \
          --add-data "resources:resources" \
          --add-data "themes:themes" \
          --add-data "config:config" \
          --add-data "app_info.json:." \
          --hidden-import PySide6.QtCore \
          --hidden-import PySide6.QtGui \
          --hidden-import PySide6.QtWidgets \
          --hidden-import PySide6.QtQml \
          --hidden-import PySide6.QtQuick \
          --hidden-import RinUI \
          --hidden-import utils.common_imports \
          --hidden-import utils.shared_utilities \
          --hidden-import utils.config_constants \
          --hidden-import utils.rinui_patch \
          --hidden-import utils.rinui_init \
          --windowed \
          main.py

    - name: Get version info and architecture
      id: version_info_macos
      run: |
        # Ê£ÄÊµãÊû∂ÊûÑ
        ARCH=$(uname -m)
        case $ARCH in
          x86_64|amd64)
            ARCH_NAME="x86_64"
            ;;
          arm64|aarch64)
            ARCH_NAME="arm64"
            ;;
          *)
            ARCH_NAME=$ARCH
            ;;
        esac

        echo "architecture=$ARCH_NAME" >> $GITHUB_OUTPUT

        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
        else
          VERSION=$(python -c "import json; print(json.load(open('app_info.json'))['version']['number'])")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    - name: Install macOS compression tools
      run: |
        # ÂÆâË£ÖÈ¢ùÂ§ñÁöÑÂéãÁº©Â∑•ÂÖ∑
        brew install p7zip xz zstd

    - name: Create extremely compressed macOS packages
      run: |
        VERSION=${{ steps.version_info_macos.outputs.version }}

        # ÂàõÂª∫Â∫îÁî®Á®ãÂ∫èÂåÖÁªìÊûÑ
        mkdir -p TimeNest.app/Contents/MacOS
        mkdir -p TimeNest.app/Contents/Resources

        # Â§çÂà∂ÂèØÊâßË°åÊñá‰ª∂
        cp dist/TimeNest TimeNest.app/Contents/MacOS/TimeNest
        chmod +x TimeNest.app/Contents/MacOS/TimeNest

        # ÂàõÂª∫Info.plistÊñá‰ª∂
        cat > TimeNest.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>TimeNest</string>
            <key>CFBundleIdentifier</key>
            <string>com.ziyi127.TimeNest</string>
            <key>CFBundleName</key>
            <string>TimeNest</string>
            <key>CFBundleVersion</key>
            <string>$VERSION</string>
            <key>CFBundleShortVersionString</key>
            <string>$VERSION</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleSignature</key>
            <string>????</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSHumanReadableCopyright</key>
            <string>Copyright ¬© 2025 ziyi127. All rights reserved.</string>
        </dict>
        </plist>
        EOF

        # Â§çÂà∂ÂõæÊ†áÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        if [ -f "resources/app_icon.png" ]; then
          cp resources/app_icon.png TimeNest.app/Contents/Resources/app_icon.png
        fi

        # ÂàõÂª∫Â§öÁßçÊûÅÈôêÂéãÁº©Ê†ºÂºè
        echo "Creating extremely compressed macOS packages..."

        ARCH="${{ steps.version_info_macos.outputs.architecture }}"

        # ÂàõÂª∫Ê†áÂáÜDMGÔºàÊúÄÈ´òÂéãÁº©Ôºâ
        hdiutil create -volname "TimeNest" -srcfolder TimeNest.app -ov -format UDBZ -imagekey bzip2-level=9 TimeNest_${VERSION}_${ARCH}.dmg
        echo "Created BZIP2 compressed DMG"

        # ÂàõÂª∫7zÂéãÁº©ÁöÑappÂåÖ
        7z a -t7z -mx=9 -mfb=273 -ms=on -mqs=on -mmt=on TimeNest_${VERSION}_${ARCH}.app.7z TimeNest.app/
        echo "Created 7z compressed app bundle"

        # ÂàõÂª∫zstdÂéãÁº©ÁöÑtarÂåÖ
        tar -I "zstd -19 --ultra -22 -T0" -cf TimeNest_${VERSION}_${ARCH}.app.tar.zst TimeNest.app/
        echo "Created zstd compressed tar"

        # ÂàõÂª∫xzÂéãÁº©ÁöÑtarÂåÖ
        tar -I "xz -9 -e -T0" -cf TimeNest_${VERSION}_${ARCH}.app.tar.xz TimeNest.app/
        echo "Created xz compressed tar"

        # ÂàõÂª∫‰æøÊê∫ÁâàZIPÔºà‰ΩøÁî®7zÊûÅÈôêÂéãÁº©Ôºâ
        mkdir -p TimeNest-portable-macos
        cp -r TimeNest.app TimeNest-portable-macos/
        cp README.md TimeNest-portable-macos/
        cp LICENSE TimeNest-portable-macos/ || echo "LICENSE not found"

        7z a -tzip -mx=9 -mfb=273 -mpass=15 -mmt=on TimeNest_${VERSION}_${ARCH}_portable.zip TimeNest-portable-macos/
        echo "Created portable ZIP with extreme compression"

        # ÊòæÁ§∫ÂéãÁº©ÊïàÊûú
        echo "Package sizes comparison:"
        ls -lh TimeNest-$VERSION-macos.* | awk '{print $5 "\t" $9}' | sort -h

    - name: Upload macOS package to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version_info_macos.outputs.tag }}
        name: TimeNest ${{ steps.version_info_macos.outputs.version }}
        body: |
          ## TimeNest ${{ steps.version_info_macos.outputs.version }} - macOS ÁâàÊú¨

          ### üì¶ macOS ‰∏ãËΩΩ
          - **macOS Â∫îÁî®Á®ãÂ∫è**: TimeNest-${{ steps.version_info_macos.outputs.version }}-macos.dmg

          ### üìã macOS ÂÆâË£ÖËØ¥Êòé
          1. ‰∏ãËΩΩ DMG Êñá‰ª∂
          2. ÂèåÂáªÊâìÂºÄ DMG Êñá‰ª∂
          3. Â∞Ü TimeNest.app ÊãñÊãΩÂà∞ Applications Êñá‰ª∂Â§π
          4. Âú® Applications ‰∏≠ÊâæÂà∞ TimeNest Âπ∂ÂêØÂä®

          ### üí° Á≥ªÁªüË¶ÅÊ±Ç
          - macOS 10.15 (Catalina) ÊàñÊõ¥È´òÁâàÊú¨
          - ÊîØÊåÅ Intel Âíå Apple Silicon (M1/M2) Â§ÑÁêÜÂô®

          ### ‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π
          È¶ñÊ¨°ËøêË°åÊó∂ÔºåÂèØËÉΩÈúÄË¶ÅÂú®"Á≥ªÁªüÂÅèÂ•ΩËÆæÁΩÆ" > "ÂÆâÂÖ®ÊÄß‰∏éÈöêÁßÅ"‰∏≠ÂÖÅËÆ∏ËøêË°åÊ≠§Â∫îÁî®Á®ãÂ∫è„ÄÇ
        draft: false
        prerelease: ${{ contains(steps.version_info_macos.outputs.version, 'Preview') || contains(steps.version_info_macos.outputs.version, 'Beta') || contains(steps.version_info_macos.outputs.version, 'RC') }}
        files: |
          TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}.dmg
          TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}.app.7z
          TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}.app.tar.zst
          TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}.app.tar.xz
          TimeNest_${{ steps.version_info_macos.outputs.version }}_${{ steps.version_info_macos.outputs.architecture }}_portable.zip

    - name: Upload macOS artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-macos
        path: |
          TimeNest-${{ steps.version_info_macos.outputs.version }}-macos.dmg
        retention-days: 30