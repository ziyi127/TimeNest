name: Build and Release

on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾æ—¶è§¦å‘å‘å¸ƒ
    branches: [ main, develop ]  # æ¨é€åˆ°åˆ†æ”¯æ—¶åªæ„å»ºï¼Œä¸å‘å¸ƒ
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Convert PNG to ICO (if needed)
      run: |
        if (!(Test-Path "resources\icons\tray_icon.ico")) {
          echo "Converting PNG to ICO format..."
          # å¦‚æœæ²¡æœ‰icoæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨åœ¨çº¿è½¬æ¢æˆ–å…¶ä»–å·¥å…·
          # è¿™é‡Œå…ˆè·³è¿‡ï¼Œä½¿ç”¨PNGæ–‡ä»¶
        }
        
    - name: Set UTF-8 encoding
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
      shell: pwsh

    - name: Build executable with spec
      run: |
        $OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"

        if (Test-Path "TimeNest.spec") {
          echo "Building with spec file..."
          pyinstaller TimeNest.spec --clean --noconfirm
        } elseif (Test-Path "build_simple.py") {
          echo "Using simple build script..."
          python build_simple.py
        } else {
          echo "Using fallback build script..."
          python build_fallback.py
        }
      shell: pwsh
        
    - name: Create portable package
      run: |
        mkdir TimeNest-portable
        copy dist\TimeNest.exe TimeNest-portable\
        copy README.md TimeNest-portable\
        copy LICENSE TimeNest-portable\
        if (Test-Path "config") { xcopy /E /I config TimeNest-portable\config }
        if (Test-Path "resources") { xcopy /E /I resources TimeNest-portable\resources }
        if (Test-Path "themes") { xcopy /E /I themes TimeNest-portable\themes }
        if (Test-Path "schedule_template.xlsx") { copy schedule_template.xlsx TimeNest-portable\ }
        
    - name: Create ZIP archive
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          Compress-Archive -Path TimeNest-portable\* -DestinationPath TimeNest-${{ github.ref_name }}-windows.zip
        } elseif ("${{ github.ref_name }}" -eq "main") {
          # ä»app_info.jsonè¯»å–ç‰ˆæœ¬ä¿¡æ¯ç”¨äºæ–‡ä»¶å
          $appInfo = Get-Content app_info.json | ConvertFrom-Json
          $version = $appInfo.version.number
          Compress-Archive -Path TimeNest-portable\* -DestinationPath TimeNest-v$version-windows.zip
        } else {
          Compress-Archive -Path TimeNest-portable\* -DestinationPath TimeNest-${{ github.sha }}-windows.zip
        }

    - name: Get release info
      id: release_info
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        } else {
          # ä»app_info.jsonè¯»å–ç‰ˆæœ¬ä¿¡æ¯
          $appInfo = Get-Content app_info.json | ConvertFrom-Json
          $version = $appInfo.version.number
          $tag = "v$version"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT

    - name: Upload Windows package to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        name: TimeNest ${{ steps.release_info.outputs.version }}
        body: |
          ## TimeNest ${{ steps.release_info.outputs.version }}

          ### ğŸ“¦ Windows ä¸‹è½½
          - **Windows ä¾¿æºç‰ˆ**: TimeNest-${{ steps.release_info.outputs.tag }}-windows.zip

          ### ğŸš€ æ–°åŠŸèƒ½
          - ğŸ”§ UIç»„ä»¶ä¿®å¤ï¼šä¿®å¤äº†RinUIç»„ä»¶ä½¿ç”¨é—®é¢˜ï¼Œæ‰€æœ‰é¡µé¢ç°åœ¨æ­£å¸¸æ˜¾ç¤º
          - âš™ï¸ è®¾ç½®é¡µé¢ä¼˜åŒ–ï¼šä½¿ç”¨åŸç”ŸSettingCardç»„ä»¶ï¼Œæä¾›æ›´å¥½çš„è®¾ç½®ä½“éªŒ
          - ğŸ¨ ç•Œé¢ç¨³å®šæ€§ï¼šè§£å†³äº†é¡µé¢ç©ºç™½å’Œç»„ä»¶å†²çªé—®é¢˜
          - ğŸ“± å“åº”å¼å¸ƒå±€ï¼šä¼˜åŒ–äº†ScrollViewå’Œå¸ƒå±€ç³»ç»Ÿ

          ### ğŸ› ä¿®å¤
          - ğŸš€ æ€§èƒ½æå‡ï¼šç§»é™¤äº†å†²çªçš„è‡ªå®šä¹‰ç»„ä»¶ï¼Œæå‡è¿è¡Œç¨³å®šæ€§
          - ä¿®å¤RinUIç»„ä»¶å±æ€§é”™è¯¯å¯¼è‡´çš„æ˜¾ç¤ºé—®é¢˜
          - ä¼˜åŒ–é¡µé¢å¸ƒå±€å’Œç»„ä»¶å®šä½é€»è¾‘

          ### ğŸ“‹ Windows å®‰è£…è¯´æ˜
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ TimeNest.exe

          ### ğŸ’¡ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11
          - Python 3.8+ (å¦‚æœä»æºç è¿è¡Œ)
          - RinUI æ¡†æ¶æ”¯æŒ

          ### âš ï¸ æ³¨æ„äº‹é¡¹
          è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°çš„ RinUI ç•Œé¢æ”¹è¿›ã€‚å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­å…ˆè¡Œä½“éªŒã€‚
        draft: false
        prerelease: ${{ contains(steps.release_info.outputs.version, 'Preview') || contains(steps.release_info.outputs.version, 'Beta') || contains(steps.release_info.outputs.version, 'RC') }}
        files: |
          TimeNest-${{ steps.release_info.outputs.tag }}-windows.zip

    - name: Upload Build Artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-windows
        path: TimeNest-${{ github.sha }}-windows.zip
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          python3-tk \
          build-essential \
          fakeroot \
          devscripts \
          debhelper \
          dh-python \
          rpm \
          alien \
          git \
          desktop-file-utils \
          qt6-base-dev \
          qt6-tools-dev \
          libgl1-mesa-dev \
          libegl1-mesa-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # å®‰è£…åŸºç¡€ä¾èµ–
        pip install pyinstaller
        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼Œå¿½ç•¥å¯èƒ½çš„é”™è¯¯
        pip install -r requirements.txt || echo "Some dependencies may have failed, continuing..."
        # ç¡®ä¿å…³é”®ä¾èµ–å·²å®‰è£…
        pip install PySide6 PyYAML requests pandas numpy openpyxl

    - name: Build Linux executable
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export QT_QPA_PLATFORM=offscreen
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        export DISPLAY=:99

        # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºï¼ˆå¦‚æœéœ€è¦ï¼‰
        sudo apt-get install -y xvfb || true
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

        # æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        pyinstaller --onefile \
          --name TimeNest \
          --add-data "qml:qml" \
          --add-data "resources:resources" \
          --add-data "themes:themes" \
          --add-data "config:config" \
          --add-data "app_info.json:." \
          --hidden-import PySide6.QtCore \
          --hidden-import PySide6.QtGui \
          --hidden-import PySide6.QtWidgets \
          --hidden-import PySide6.QtQml \
          --hidden-import PySide6.QtQuick \
          --hidden-import RinUI \
          --hidden-import utils.common_imports \
          --hidden-import utils.shared_utilities \
          --hidden-import utils.config_constants \
          --windowed \
          main.py

    - name: Get version info
      id: version_info
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
        else
          VERSION=$(python -c "import json; print(json.load(open('app_info.json'))['version']['number'])")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    - name: Create application directory structure
      run: |
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/bin
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/applications
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/pixmaps
        mkdir -p TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/timenest

        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/TimeNest TimeNest-${{ steps.version_info.outputs.version }}/usr/bin/timenest
        chmod +x TimeNest-${{ steps.version_info.outputs.version }}/usr/bin/timenest

        # åˆ›å»ºæ¡Œé¢æ–‡ä»¶
        cat > TimeNest-${{ steps.version_info.outputs.version }}/usr/share/applications/timenest.desktop << EOF
        [Desktop Entry]
        Name=TimeNest
        Comment=æ™ºèƒ½æ—¶é—´ç®¡ç†åŠ©æ‰‹
        Exec=timenest
        Icon=timenest
        Terminal=false
        Type=Application
        Categories=Office;Utility;
        StartupNotify=true
        EOF

        # å¤åˆ¶å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "resources/icons/app_icon.png" ]; then
          cp resources/icons/app_icon.png TimeNest-${{ steps.version_info.outputs.version }}/usr/share/pixmaps/timenest.png
        fi

        # å¤åˆ¶æ–‡æ¡£
        cp README.md TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/timenest/
        cp LICENSE TimeNest-${{ steps.version_info.outputs.version }}/usr/share/doc/timenest/ || echo "LICENSE file not found"

    - name: Create Debian package
      run: |
        VERSION=${{ steps.version_info.outputs.version }}

        # åˆ›å»ºDEBIANæ§åˆ¶ç›®å½•
        mkdir -p TimeNest-$VERSION/DEBIAN

        # åˆ›å»ºcontrolæ–‡ä»¶
        cat > TimeNest-$VERSION/DEBIAN/control << EOF
        Package: timenest
        Version: $VERSION
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: python3 (>= 3.8), python3-tk, libqt6core6, libqt6gui6, libqt6widgets6
        Maintainer: ziyi127 <ziyihed@outlook.com>
        Description: æ™ºèƒ½æ—¶é—´ç®¡ç†åŠ©æ‰‹
         TimeNestæ˜¯ä¸€ä¸ªåŸºäºPythonã€RinUIå’ŒPySide6å¼€å‘çš„ç°ä»£åŒ–è¯¾ç¨‹è¡¨ç®¡ç†å·¥å…·ï¼Œ
         ä¸“ä¸ºå­¦ç”Ÿã€æ•™å¸ˆå’Œæ•™è‚²å·¥ä½œè€…è®¾è®¡ã€‚æä¾›æ™ºèƒ½æ—¶é—´ç®¡ç†ã€è¯¾ç¨‹è¡¨ç®¡ç†ã€
         ä»»åŠ¡æé†’ã€æ‚¬æµ®çª—æ˜¾ç¤ºç­‰åŠŸèƒ½ã€‚
        Homepage: https://ziyi127.github.io/TimeNest-Website
        EOF

        # åˆ›å»ºpostinstè„šæœ¬
        cat > TimeNest-$VERSION/DEBIAN/postinst << EOF
        #!/bin/bash
        set -e
        update-desktop-database || true
        EOF
        chmod +x TimeNest-$VERSION/DEBIAN/postinst

        # åˆ›å»ºprermè„šæœ¬
        cat > TimeNest-$VERSION/DEBIAN/prerm << EOF
        #!/bin/bash
        set -e
        update-desktop-database || true
        EOF
        chmod +x TimeNest-$VERSION/DEBIAN/prerm

        # æ„å»ºdebåŒ…
        dpkg-deb --build TimeNest-$VERSION
        mv TimeNest-$VERSION.deb timenest_$VERSION-1_amd64.deb

    - name: Create RPM package
      run: |
        VERSION=${{ steps.version_info.outputs.version }}

        # åˆ›å»ºRPMæ„å»ºç›®å½•ç»“æ„
        mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

        # åˆ›å»ºspecæ–‡ä»¶
        cat > rpmbuild/SPECS/timenest.spec << EOF
        Name:           timenest
        Version:        $VERSION
        Release:        1%{?dist}
        Summary:        æ™ºèƒ½æ—¶é—´ç®¡ç†åŠ©æ‰‹

        License:        MIT
        URL:            https://ziyi127.github.io/TimeNest-Website
        Source0:        %{name}-%{version}.tar.gz

        BuildRequires:  python3-devel
        Requires:       python3 >= 3.8, python3-tkinter, qt6-qtbase

        %description
        TimeNestæ˜¯ä¸€ä¸ªåŸºäºPythonã€RinUIå’ŒPySide6å¼€å‘çš„ç°ä»£åŒ–è¯¾ç¨‹è¡¨ç®¡ç†å·¥å…·ï¼Œ
        ä¸“ä¸ºå­¦ç”Ÿã€æ•™å¸ˆå’Œæ•™è‚²å·¥ä½œè€…è®¾è®¡ã€‚æä¾›æ™ºèƒ½æ—¶é—´ç®¡ç†ã€è¯¾ç¨‹è¡¨ç®¡ç†ã€
        ä»»åŠ¡æé†’ã€æ‚¬æµ®çª—æ˜¾ç¤ºç­‰åŠŸèƒ½ã€‚

        %prep
        %setup -q

        %build
        # å·²ç»é¢„æ„å»º

        %install
        rm -rf \$RPM_BUILD_ROOT
        mkdir -p \$RPM_BUILD_ROOT/usr/bin
        mkdir -p \$RPM_BUILD_ROOT/usr/share/applications
        mkdir -p \$RPM_BUILD_ROOT/usr/share/pixmaps
        mkdir -p \$RPM_BUILD_ROOT/usr/share/doc/%{name}

        cp ../dist/TimeNest \$RPM_BUILD_ROOT/usr/bin/timenest
        cp ../TimeNest-$VERSION/usr/share/applications/timenest.desktop \$RPM_BUILD_ROOT/usr/share/applications/
        cp ../resources/app_icon.png \$RPM_BUILD_ROOT/usr/share/pixmaps/timenest.png || true
        cp ../README.md \$RPM_BUILD_ROOT/usr/share/doc/%{name}/
        cp ../LICENSE \$RPM_BUILD_ROOT/usr/share/doc/%{name}/ || true

        %files
        /usr/bin/timenest
        /usr/share/applications/timenest.desktop
        /usr/share/pixmaps/timenest.png
        /usr/share/doc/%{name}/README.md
        /usr/share/doc/%{name}/LICENSE

        %post
        update-desktop-database &> /dev/null || :

        %postun
        update-desktop-database &> /dev/null || :

        %changelog
        * $(date +'%a %b %d %Y') ziyi127 <ziyihed@outlook.com> - $VERSION-1
        - TimeNest $VERSION release
        EOF

        # åˆ›å»ºæºç åŒ…
        cd ..
        tar -czf rpmbuild/SOURCES/timenest-$VERSION.tar.gz \
          --transform "s,^,timenest-$VERSION/," \
          dist/TimeNest \
          TimeNest-$VERSION/usr/share/applications/timenest.desktop \
          README.md LICENSE || echo "Some files may be missing, continuing..."
        cd rpmbuild

        # æ„å»ºRPMåŒ…
        rpmbuild --define "_topdir $(pwd)" -ba SPECS/timenest.spec || echo "RPM build failed, creating simple archive instead"

        # å¤åˆ¶ç”Ÿæˆçš„RPMåŒ…æˆ–åˆ›å»ºå¤‡ç”¨åŒ…
        if [ -f "RPMS/x86_64/timenest-$VERSION-1.*.rpm" ]; then
          cp RPMS/x86_64/timenest-$VERSION-1.*.rpm ../
        else
          # åˆ›å»ºç®€å•çš„tar.gzä½œä¸ºå¤‡ç”¨
          cd ..
          tar -czf timenest-$VERSION-1.x86_64.rpm.tar.gz TimeNest-$VERSION/
        fi
        cd ..

    - name: Create Arch Linux package
      run: |
        VERSION=${{ steps.version_info.outputs.version }}

        # å®‰è£…makepkgä¾èµ–
        sudo apt-get install -y binutils fakeroot

        # åˆ›å»ºPKGBUILDç›®å½•
        mkdir -p archpkg
        cd archpkg

        # åˆ›å»ºPKGBUILDæ–‡ä»¶
        cat > PKGBUILD << EOF
        # Maintainer: ziyi127 <ziyihed@outlook.com>
        pkgname=timenest
        pkgver=$VERSION
        pkgrel=1
        pkgdesc="æ™ºèƒ½æ—¶é—´ç®¡ç†åŠ©æ‰‹"
        arch=('x86_64')
        url="https://ziyi127.github.io/TimeNest-Website"
        license=('MIT')
        depends=('python' 'python-pyside6' 'qt6-base')
        makedepends=('python-build' 'python-installer' 'python-wheel')
        source=("timenest-\$pkgver.tar.gz")
        sha256sums=('SKIP')

        package() {
            install -Dm755 "../dist/TimeNest" "\$pkgdir/usr/bin/timenest"
            install -Dm644 "../TimeNest-$VERSION/usr/share/applications/timenest.desktop" "\$pkgdir/usr/share/applications/timenest.desktop"
            install -Dm644 "../README.md" "\$pkgdir/usr/share/doc/\$pkgname/README.md"
            if [ -f "../LICENSE" ]; then
                install -Dm644 "../LICENSE" "\$pkgdir/usr/share/licenses/\$pkgname/LICENSE"
            fi
            if [ -f "../resources/icons/app_icon.png" ]; then
                install -Dm644 "../resources/icons/app_icon.png" "\$pkgdir/usr/share/pixmaps/timenest.png"
            fi
        }
        EOF

        # åˆ›å»ºæºç åŒ…
        tar -czf timenest-$VERSION.tar.gz -C .. dist/TimeNest README.md LICENSE

        # æ„å»ºåŒ…ï¼ˆåœ¨Ubuntuä¸Šæ¨¡æ‹Ÿï¼Œå®é™…åº”è¯¥åœ¨Archä¸Šæ„å»ºï¼‰
        # è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªtar.xzåŒ…ä½œä¸ºæ›¿ä»£
        cd ..
        mkdir -p archpkg-built/usr/bin
        mkdir -p archpkg-built/usr/share/applications
        mkdir -p archpkg-built/usr/share/doc/timenest
        mkdir -p archpkg-built/usr/share/pixmaps

        cp dist/TimeNest archpkg-built/usr/bin/timenest
        cp TimeNest-$VERSION/usr/share/applications/timenest.desktop archpkg-built/usr/share/applications/
        cp README.md archpkg-built/usr/share/doc/timenest/
        cp LICENSE archpkg-built/usr/share/doc/timenest/ || true
        if [ -f "resources/icons/app_icon.png" ]; then
          cp resources/icons/app_icon.png archpkg-built/usr/share/pixmaps/timenest.png
        fi

        # åˆ›å»ºåŒ…ä¿¡æ¯æ–‡ä»¶
        cat > archpkg-built/.PKGINFO << EOF
        pkgname = timenest
        pkgver = $VERSION-1
        pkgdesc = æ™ºèƒ½æ—¶é—´ç®¡ç†åŠ©æ‰‹
        url = https://ziyi127.github.io/TimeNest-Website
        builddate = $(date +%s)
        packager = ziyi127 <ziyihed@outlook.com>
        size = $(du -sb archpkg-built | cut -f1)
        arch = x86_64
        depend = python
        depend = python-pyside6
        depend = qt6-base
        EOF

        # åˆ›å»ºtar.xzåŒ…
        cd archpkg-built
        tar -cJf ../timenest-$VERSION-1-x86_64.pkg.tar.xz .
        cd ..

    - name: Upload Linux packages to release
      if: github.ref_name == 'main' || github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version_info.outputs.tag }}
        name: TimeNest ${{ steps.version_info.outputs.version }}
        body: |
          ## TimeNest ${{ steps.version_info.outputs.version }} - Linux å®‰è£…åŒ…

          ### ğŸ“¦ Linux ä¸‹è½½
          - **Debian/Ubuntu**: timenest_${{ steps.version_info.outputs.version }}-1_amd64.deb
          - **Red Hat/CentOS/Fedora**: timenest-${{ steps.version_info.outputs.version }}-1.x86_64.rpm
          - **Arch Linux**: timenest-${{ steps.version_info.outputs.version }}-1-x86_64.pkg.tar.xz

          ### ğŸ“‹ å®‰è£…è¯´æ˜

          **Debian/Ubuntu:**
          ```bash
          sudo dpkg -i timenest_${{ steps.version_info.outputs.version }}-1_amd64.deb
          sudo apt-get install -f  # è§£å†³ä¾èµ–é—®é¢˜
          ```

          **Red Hat/CentOS/Fedora:**
          ```bash
          sudo rpm -ivh timenest-${{ steps.version_info.outputs.version }}-1.x86_64.rpm
          # æˆ–ä½¿ç”¨ dnf/yum
          sudo dnf install timenest-${{ steps.version_info.outputs.version }}-1.x86_64.rpm
          ```

          **Arch Linux:**
          ```bash
          sudo pacman -U timenest-${{ steps.version_info.outputs.version }}-1-x86_64.pkg.tar.xz
          ```

          ### ğŸš€ è¿è¡Œ
          å®‰è£…å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯åŠ¨ï¼š
          - å‘½ä»¤è¡Œ: `timenest`
          - åº”ç”¨èœå•: æœç´¢ "TimeNest"
        draft: false
        prerelease: ${{ contains(steps.version_info.outputs.version, 'Preview') || contains(steps.version_info.outputs.version, 'Beta') || contains(steps.version_info.outputs.version, 'RC') }}
        files: |
          timenest_${{ steps.version_info.outputs.version }}-1_amd64.deb
          timenest-${{ steps.version_info.outputs.version }}-1*.rpm*
          timenest-${{ steps.version_info.outputs.version }}-1-x86_64.pkg.tar.xz

    - name: Upload Linux artifacts (for non-release builds)
      if: github.ref_name != 'main' && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: TimeNest-${{ github.sha }}-linux-packages
        path: |
          timenest_${{ steps.version_info.outputs.version }}-1_amd64.deb
          timenest-${{ steps.version_info.outputs.version }}-1*.rpm*
          timenest-${{ steps.version_info.outputs.version }}-1-x86_64.pkg.tar.xz
        retention-days: 30