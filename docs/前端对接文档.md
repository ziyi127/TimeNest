# TimeNest 前端对接文档

## 1. 概述

本文档旨在为后端开发者提供关于 TimeNest 智能课程表软件前端组件的详细信息，以便更好地进行前后端对接开发。TimeNest 采用前后端分离的架构设计，前端使用 PySide6 构建桌面应用，后端使用 Flask 提供 RESTful API 接口。

## 2. 前端架构

### 2.1 技术栈

- **编程语言**: Python 3.8+
- **GUI 框架**: PySide6 (Qt for Python)
- **HTTP 客户端**: requests
- **数据格式**: JSON

### 2.2 项目结构

```
frontend/
├── __init__.py
├── api_client.py          # API 客户端，与后端通信
├── main.py                # 前端应用入口点
├── system_tray_icon.py    # 系统托盘图标
└── gui/
    ├── __init__.py
    ├── floating_window.py # 悬浮窗组件
    ├── management_window.py # 管理窗口组件
    └── dialogs/
        ├── __init__.py
        ├── course_edit_dialog.py # 课程编辑对话框
        └── schedule_edit_dialog.py # 课程表编辑对话框
```

### 2.3 应用入口

前端应用的入口点是 `frontend/main.py` 文件中的 `TimeNestFrontendApp` 类。该类继承自 `QApplication`，负责初始化整个前端应用，包括创建悬浮窗、系统托盘图标以及加载数据。

### 2.4 主要组件

1. **悬浮窗 (`floating_window.py`)**: 显示当前时间和课程状态的桌面悬浮窗，用户可以双击打开管理窗口。
2. **管理窗口 (`management_window.py`)**: 提供课程、课程表和临时换课记录的管理界面。
3. **系统托盘图标 (`system_tray_icon.py`)**: 在系统托盘中显示图标，提供应用控制菜单。

## 3. API 接口规范

前端通过 `frontend/api_client.py` 文件中的 `APIClient` 类与后端进行通信。以下是前端需要调用的 API 接口规范：

### 3.1 课程管理接口

#### 获取所有课程
- **URL**: `GET /api/courses`
- **描述**: 获取所有课程信息
- **响应**: 课程列表，每个课程包含以下字段：
  - `id` (string): 课程唯一标识
  - `name` (string): 课程名称
  - `teacher` (string): 任课教师
  - `location` (string): 上课地点
  - `duration` (object): 课程时间
    - `start_time` (string): 开始时间 (HH:MM)
    - `end_time` (string): 结束时间 (HH:MM)

#### 保存课程
- **URL**: `POST /api/courses`
- **描述**: 保存课程信息
- **请求体**: 课程列表，格式与获取接口响应相同
- **响应**: 成功或失败状态

### 3.2 课程表管理接口

#### 获取所有课程表项
- **URL**: `GET /api/schedules`
- **描述**: 获取所有课程表项信息
- **响应**: 课程表项列表，每个课程表项包含以下字段：
  - `id` (string): 课程表项唯一标识
  - `day_of_week` (integer): 星期几 (0-6，0表示星期日)
  - `week_parity` (string): 周次 (odd/even/both)
  - `course_id` (string): 关联课程ID
  - `valid_from` (string): 有效期开始日期 (YYYY-MM-DD)
  - `valid_to` (string): 有效期结束日期 (YYYY-MM-DD)

#### 保存课程表项
- **URL**: `POST /api/schedules`
- **描述**: 保存课程表项信息
- **请求体**: 课程表项列表，格式与获取接口响应相同
- **响应**: 成功或失败状态

### 3.3 临时换课管理接口

#### 获取所有临时换课记录
- **URL**: `GET /api/temp_changes`
- **描述**: 获取所有临时换课记录信息
- **响应**: 临时换课记录列表，每个记录包含以下字段：
  - `id` (string): 临时换课记录唯一标识
  - `original_schedule_id` (string): 原始课程表项ID
  - `new_course_id` (string): 新课程ID
  - `change_date` (string): 换课日期 (YYYY-MM-DD)
  - `is_permanent` (boolean): 是否为永久换课
  - `used` (boolean): 是否已使用

#### 保存临时换课记录
- **URL**: `POST /api/temp_changes`
- **描述**: 保存临时换课记录信息
- **请求体**: 临时换课记录列表，格式与获取接口响应相同
- **响应**: 成功或失败状态

### 3.4 设置管理接口

#### 获取应用设置
- **URL**: `GET /api/settings`
- **描述**: 获取应用设置信息
- **响应**: 设置信息，包含以下字段：
  - `theme` (string): 主题 (light/dark)
  - `language` (string): 语言 (zh-CN/en-US)
  - `auto_backup` (boolean): 是否自动备份
  - `backup_interval` (integer): 备份间隔 (小时)
  - `data_dir` (string): 数据目录路径

#### 保存应用设置
- **URL**: `POST /api/settings`
- **描述**: 保存应用设置信息
- **请求体**: 设置信息，格式与获取接口响应相同
- **响应**: 成功或失败状态

### 3.5 今日课程安排接口

#### 获取今日课程安排
- **URL**: `GET /api/today_schedule`
- **描述**: 获取今日课程安排信息
- **响应**: 今日课程安排信息，包含以下字段：
  - `type` (string): 课程类型 (none/regular/temp)
  - `course` (object, optional): 课程信息 (当type为regular或temp时存在)
  
  该接口已在后端实现，返回今日的课程安排信息。如果有未使用的临时换课，则返回临时换课的课程信息；否则返回常规课程表中的课程信息；如果没有课程则返回type为none。

## 4. 数据模型

### 4.1 课程模型

```json
{
  "id": "string",
  "name": "string",
  "teacher": "string",
  "location": "string",
  "duration": {
    "start_time": "HH:MM",
    "end_time": "HH:MM"
  }
}
```

### 4.2 课程表模型

```json
{
  "id": "string",
  "day_of_week": "integer (0-6)",
  "week_parity": "string (odd/even/both)",
  "course_id": "string",
  "valid_from": "date",
  "valid_to": "date"
}
```

### 4.3 临时换课模型

```json
{
  "id": "string",
  "original_schedule_id": "string",
  "new_course_id": "string",
  "change_date": "date",
  "is_permanent": "boolean",
  "used": "boolean"
}
```

## 5. 错误处理

前端期望后端 API 接口在出错时返回标准的 HTTP 状态码和 JSON 格式的错误信息：

```json
{
  "error": "错误描述",
  "details": ["详细错误信息"]
}
```

常见的 HTTP 状态码：
- `200`: 请求成功
- `201`: 创建成功
- `400`: 请求参数错误
- `404`: 资源未找到
- `409`: 资源冲突
- `500`: 服务器内部错误

## 6. 开发建议

1. **数据一致性**: 前端在保存数据时会一次性提交完整的数据列表，后端应确保数据的一致性。
2. **错误处理**: 后端应提供详细的错误信息，便于前端进行错误提示。
3. **性能优化**: 对于大量数据的查询，建议后端实现分页或懒加载机制。
4. **安全性**: 后端应对输入数据进行验证，防止恶意数据注入。

## 7. 测试建议

1. **单元测试**: 为每个 API 接口编写单元测试，确保功能正确性。
2. **集成测试**: 进行前后端集成测试，验证数据传输和处理的正确性。
3. **性能测试**: 对高频访问的接口进行性能测试，确保响应时间满足要求。
